# Aurora

## Aurora란?
- 클라우드를 위해 구축된 MySQL 및 PostgresSQL 호환 관계형 데이터베이스입니다.
- 빠르고 가격이 저렴하며 보안,가용성,안정성을 제공하며 소모적 관리 자동화 서비스인 RDS 에서 모든것을 관리합니다. 

## RDS의 아키텍처
- ### Single Master
    - Aurora Storage Cluster 로 인해 한 VPC 안에 있는 여러 AZ에 걸쳐 클러스터를 형성합니다.
    - AZ마다 쓰기 , 읽기 전용등으로 인스턴스를 관리할 수 있습니다. 단 읽기/쓰기 전용 노드는 하나입니다.
    
- ### Multi Master
    - 클러스터 구조는 Single Master 와 동일하나 여러 노드들이 읽기/쓰기 작업을 할 수 있습니다.
    - 동시에 여러 마스터에서 작업을 진행할 수 있습니다.
    - 최대 4개의 노드가 읽기/쓰기 담당
        - 각 노드는 독립적 : 정지/재부팅/삭제에 서로 영향을 받지 않습니다.
    - 지속적인 가용성 제공
    - 주로 Multitenant 혹은 Sharding 이 적용된 어플리케이션에 좋은 성능

## 특징
- MySQL , PostgresSQL 지원
- 두가지모드
    - 싱글 모드
        - 쓰기 전용 노드 1개와 다수의 읽기 전용 노드로 구성
        - 총 15개 Replica 생성 가능
        - Async 복제
        - 하나의 리전안에 생성 가능
        - Writer 가 죽을 경우 자동으로 Replica 중 하나가 Writer 으로 Failover
            - 고가용성 확보
        - 대부분 경우 싱글 모드 사용
    - 멀티 모드
        - 다수의 노드로 읽기/쓰기가 가능한 Multi Master

- 용량 자동 증감
    - 10GB 부터 10GB 단위로 최대 128TB까지 증가 가능

- 연산 능력 
    - 96vCPU , 768GB 까지 증가 가능 (db.r5.24xlarge)

- 데이터의 분산 저장
    - 각 AZ마다 2개의 데이터 복제본 저장 x 최소 3개 이상의 AZ = 최소 6개의 복제본
    - 3개 이상을 잃어버리기 전엔 쓰기 능력이 유지
    - 4개 이상을 잃어버리기 전에는 읽기 능력 유지
    - 손실된 복제본은 자가 치유 : 지속적으로 손실된 부분을 검사 후 복구
    - Quorum 모델 사용 
        - 다수결 투표 합의

## 병렬 쿼리
- ### 특징
    - 다수의 읽기 노드를 통해 쿼리를 병렬로 처리하는 모드
    - 빠르고 부하 분산에 강함
    - MySQL 5.6 / 5.7 에서만 지원 
    - 몇몇 낮은 인스턴스 [db.t2 , db.t3] 에서는 지원하지 않음

## 백업
- ### 특징
    - 읽기 복제본 (Read Replica) 지원 (Aurora Replica 와 다른 개념)
        - MySQL DB의 Binary log 복제 (Binlog)
        - 단 다른 리전에서만 생성 가능
    - RDS 와 마찬가지로 자동/수동 백업 가능
        - 자동 백업의 경우 1~35일 동안 보관 (S3에 보관)
        - 수동 백업 (스냅샷) 가능
        - 백업 데이터 복원 시 다른 데이터베이스 생성

## Aurora 데이터베이스 클로닝
- ### 특징
    - 기존의 데이터베이스에서 새로운 데이터베이스를 복제
        - 스냅샷을 통해 새로운 데이터베이스를 생성하는 것 보다 빠르고 저렴함
    - Copy-On-Write 프로토콜 사용
    - 기존 클러스터를 삭제해도 정상 동작
    - 클론 
        - 클론 시 생성된 데이터베이스가 기존 데이터베이스를 참조
        - 기존 데이터베이스와 복제 데이터베이스에 변경사항 발생 시 새 데이터베이스 생성

## BackTrack
- ### 특징
    - 기존의 DB를 특정 시점으로 되돌리는 것 (새로운 DB 가 아니라 기존 DB)
        - DB 관리의 실수를 쉽게 만회 가능 (ex : Where 없는 Delete)
        - 새로운 DB를 생성하는 것 보다 빠름
        - 앞 뒤 시점을 이동할 수 있기 때문에 원하는 지점을 빠르게 찾을수 있음
    - BackTrack Window
        - Target BackTrack Window 
            - 최대값 : 72
            - 어느 시점 만큼 DB를 되돌리기 위한 데이터를 저장할 것인지
                - 지정 시점 이전으로는 BackTrack 불가능
        - Actual BackTrack Window
            - 실제로 시간을 얼만큼 되돌릴지
            - Target BackTrack Window 보다는 작아야 함
    - BackTrack 활성화 시 시간당 DB의 변화를 저장
        - 저장 된 용량만큼 비용 지불
        - DB 변화가 많을수록 많은 로그 = 많은 비용
        - DB로그가 많아 Actual BackTrack Window 가 Target BackTrack Window (설정값) 보다 작을경우 , 알림 서비스
    - MySql 에서만 가능
    - Aurora 초기 설정 시 BackTrack을 설정 한 DB만 BackTrack 가능
        - 스냅샷 , Clone 을 통해 활성화 가능
    - Multi - Master 상태에서는 BackTrack 불가능

## Aurora Global Database
- ### 특징
    - 전 세계 모든 리전에서 1초 내의 지연 시간으로 데이터 엑세스 가능
    - 재해복구용도로 활용 가능
        - 유사시 보조 리전중 하나를 승격하여 메인으로 사용
        - 1초의 PRO (복구 목표 지점)
            - 이슈 발생 시 1초 데이터 로스가 있을 수 있음
        - 1분 미만의 RTO (복구 목표 시간)
            - 이슈 발생 시 복구 1분이 걸림
            - 데이터 로스 1초
    - 보조 리전에는 총 16개의 Read 전용


## Aurora 자가 복구 분산 스토리지
- ### 특징
    - 데이터베이스 인스턴스당 최대 128TB까지 자동 확장
    - 지연시간이 짧은 읽기 전용 복제본 최대 15개 , 특정 시점으로 복구 , S3로 지속적 백업 , 3개의 AZ 에 걸친 복제 등
    - 인스턴스와 스토리지(EBS) 가 분리되어 네트워크 통신
    - 동기/비동기 복제
        - 같은 리전으로 동기 복제
        - 다른 리전으로 비동기 복제
- ### 문제점
    - 동기 복제 문제점
        - Data Write 시 처리속도가 모든 EBS 중 가장 늦게 처리 된 시간만큼 걸리게 됨
    - 비동기 복제 문제점
        - 복제 fail 시 저장 실패
    - 복제 복구 문제
        - 굉장히 큰 DB 복제 실패 시 다시 생성 이슈

## Quorum Model
- ### 특징 
    - 읽기 혹은 쓰기를 분산 노드 중 일부분에서만 수행
    - 다수결 합의
        - 인스턴스에서 보낸 요청을 각 disk 에서 과반수가 넘게 되면 저장됨
    - MTTF (Mean Time To Failure)
        - 실패까지 걸리는 시간
    - MTTR (Mean Time To Repair) 
        - 복구까지 걸리는 시간
- ### 규칙
    - 읽기 쿼럼과 쓰기쿼럼은 적어도 하나 이상의 노드가 겹쳐야 함
    - 쓰기를 완료하려면 , 이번에 사용할 쓰기 쿼럼과 이전에 쓰기를 완료한 쓰기 쿼럼이 겹쳐야 함
    - 최소 쿼럼
        - 쓰기 쿼럼 과반 초과
        - 읽기 쿼럼 과반 이상
    

## Log Sequence Number (LSN)
- ### 특징
    - 데이터베이스 로그파일에서 특정 로그 파일의 위치 혹은 오프셋
    - 쓰여진 데이터 바이트만큼 추가
    - 각 쿼리 (=로그파일) 별로 고유의 값 획득 (계속 증가)
    - 해당 LSN 의 쿼리를 처리하려면 이전 LSN 쿼리들이 처리되어야 함
        - LSN : 10 > 이전 LSN 0~9 가 완료가 되어야 함
    
